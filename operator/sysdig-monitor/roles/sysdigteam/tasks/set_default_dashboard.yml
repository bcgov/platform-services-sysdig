---
# Create / Apply default dashboard for Container Scope

# Since API tokens are Team Scoped,
# we need to use a Service Account user who has been added to the team,
# then fetch the token for dashboard configuration

- name: Use Platform Services Team Service Account from Sysdig
  set_fact:
    team_admin_username: "{{ sysdig_team_sa.name }}"
    team_id: "{{ team_container_creation_output.json.team.id }}"
    target_namespace: "{{ prod_namespace }}"

- name: Get token from Admin user of container team
  uri: 
    url: "{{ sysdig_api_endpoint }}/api/token/{{ team_admin_username }}/{{ team_id }}"
    method: GET
    headers:
        Authorization: "Bearer {{ sysdig_token }}"
        Content-Type: "application/json"
  register: container_team_admin_user_token
  when: container_team_exists == false

# Add the dashboard that each team will need
- name: Set Resource Usage Dashboard
  uri: 
    url: "{{ sysdig_api_endpoint }}/api/v3/dashboards/"
    method: POST
    headers:
        Authorization: "Bearer {{ container_team_admin_user_token.json.token.key }}"
        Content-Type: "application/json"
    body: "{{ lookup('template', 'templates/dashboard-template-resource-allocation.json.j2') }}"
    body_format: json
    status_code: 201
  register: default_dashboard_creation_output
  when: container_team_exists == false
